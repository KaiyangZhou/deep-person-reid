from typing import Counter
from elasticsearch import Elasticsearch
import json
import urllib.request
import os
import argparse
from timeit import default_timer as timer
import shutil
from functools import cache
import time
from tqdm import tqdm
from vars import url, api_key_1, api_key_2
import logging
from torchreid.utils import FeatureExtractor
from datetime import datetime
import numpy
'''
Takes in a query and adds the feature vectors into elastic search
query can be dynamically ajusted based in time frame. Currently feature vectors are only
used on
'''


name = 'image'

input_path = f"./media/{name}/"

es = Elasticsearch(url, api_key=(api_key_1, api_key_2))

f = open('query.json',)
search_query = json.load(f)
global_end_time = datetime.now().isoformat()
global_start_time = '2022-10-13T07:17:15.892850'

script_query = {
    "knn": {
        "title_vector": {
            "person_vectors": [0, 0, 0.6193708777427673, 0, 0.5590583086013794, 1.7233480215072632, 1.6359997987747192, 1.2494447231292725, 0, 1.5017286539077759, 0.5623013377189636, 0.842857837677002, 0, 0.084873266518116, 1.3867148160934448, 0, 0, 0, 0, 0, 0.9529091715812683, 0, 2.9566900730133057, 1.471923828125, 1.1121882200241089, 0.7485089302062988, 0.7401481866836548, 0, 1.6858142614364624, 0, 0.8459492921829224, 0.20694898068904877, 0.14726175367832184, 1.8069303035736084, 0, 1.2529098987579346, 0.47481006383895874, 3.869520664215088, 0.14618907868862152, 0.7175511121749878, 0, 2.112626075744629, 1.5706543922424316, 0, 0, 0.7427644729614258, 2.1491756439208984, 0.3695194125175476, 0, 0, 0.5785930156707764, 0.9143006205558777, 0, 0.08218735456466675, 1.1958061456680298, 1.443885087966919, 0, 0, 0.3958214819431305, 0, 0.7842020988464355, 0, 2.1873979568481445, 1.5139737129211426, 0, 0.627311110496521, 0.13157546520233154, 0.9071311950683594, 0, 0, 0.0981014296412468, 0, 0.8345497250556946, 0.9029178023338318, 0, 2.7185165882110596, 0, 0.19429558515548706, 0.44936156272888184, 1.331305980682373, 2.091032028198242, 1.1569452285766602, 0.11735282093286514, 0, 0, 0.3779544234275818, 1.639153003692627, 2.048689126968384, 1.3418420553207397, 0, 0.8699010014533997, 1.3082821369171143, 0, 0, 0, 0, 0, 0.14066064357757568, 0, 0.35670873522758484, 0.22987712919712067, 0.2763562798500061, 0.3431469798088074, 0.21364618837833405, 0, 0.8009331822395325, 1.5586233139038086, 0.8960123658180237, 0, 0, 0.68536776304245, 0, 1.1055563688278198, 1.2865277528762817, 0, 1.3089321851730347, 0.2888738512992859, 0.6949865818023682, 0.29715514183044434, 0.5351228713989258, 0.7844171524047852, 0, 0.6405286192893982, 0, 1.2233097553253174, 0, 0.6684241890907288, 0, 1.0590044260025024, 1.3211462497711182, 0, 0.7293972373008728, 0.8657063245773315, 0.9884830713272095, 4.28688383102417, 0.17582756280899048, 0, 0.6103484630584717, 0.8099682331085205, 1.2349967956542969, 2.092118978500366, 0, 1.0835133790969849, 0, 1.7488795518875122, 0.8819239139556885, 0.27407070994377136, 1.4124361276626587, 0.6474932432174683, 0.002483373275026679, 2.510873794555664, 0.8605020046234131, 0, 3.2520875930786133, 0.8060807585716248, 0.06297824531793594, 0.862331748008728, 1.5968199968338013, 1.1278043985366821, 0, 0, 0, 0.9509069323539734, 0.9834874868392944, 1.0749009847640991, 1.0213184356689453, 0.7195379734039307, 1.5252277851104736, 0, 0.1461380273103714, 1.7516717910766602, 0.02117319218814373, 0.28941819071769714, 0.40569809079170227, 0.4732136130332947, 0.8359521627426147, 0.33171892166137695, 0, 0, 0.654848039150238, 1.81807279586792, 0, 1.0039112567901611, 1.0423848628997803, 0.6348509788513184, 0.577405571937561, 1.2420376539230347, 1.4450880289077759, 1.3959521055221558, 0.02042504772543907, 0, 1.3609585762023926, 0, 0.08283798396587372, 0, 0.39074504375457764, 3.9342472553253174, 0, 0.981215238571167, 0.18133948743343353, 0.4180661737918854, 3.305741548538208, 0.12723951041698456, 1.6946250200271606, 1.8990402221679688, 0.0991145521402359, 0.7732234001159668, 0, 2.1260340213775635, 0.2989635765552521, 1.573809266090393, 0, 0.4381769299507141, 0.5262685418128967, 2.7436068058013916, 1.2113786935806274, 0, 1.0646040439605713, 0.6448156833648682, 1.0424833297729492, 0.20037396252155304, 0, 0, 2.7326343059539795, 0.11794870346784592, 2.590043067932129, 0.8372560143470764, 0, 1.1716117858886719, 0.5398963093757629, 0, 1.670686960220337, 0, 0.3447898030281067, 0.6702333688735962, 0.2960618734359741, 0, 0, 0.08744576573371887, 0, 1.6770799160003662, 0, 0.9772729277610779, 0, 0, 0, 0, 1.1157751083374023, 0.7066763639450073, 0.9953616261482239, 2.367464780807495, 2.9454283714294434, 0, 2.2359461784362793, 0.8644796013832092, 3.890673875808716, 1.1137537956237793, 0.08563023060560226, 0, 1.2741118669509888, 4.3824310302734375, 0.6306523084640503, 0.514849841594696, 0, 0, 0, 0.9503476619720459, 1.1175516843795776, 0, 0.8123998641967773, 0, 0.5832048058509827, 0.22607380151748657, 2.8173794746398926, 0.3438666760921478, 0, 0.6007508635520935, 0, 1.3476200103759766, 1.6057040691375732, 0.8077424168586731, 1.730183720588684, 1.3474503755569458, 0, 1.7388068437576294, 0, 0.19674906134605408, 0.986963152885437, 0.4897812008857727, 3.8339755535125732, 1.1463543176651, 0, 1.1044796705245972, 0, 0, 0, 0, 1.4661842584609985, 0.3016698658466339, 0, 0.2873898446559906, 0, 0.39565911889076233, 0, 2.122116804122925, 0.4209024906158447, 0.11920846253633499, 0.12491429597139359, 1.1260243654251099, 0.17565810680389404, 0, 0.9066485166549683, 0.9498580694198608, 3.1789159774780273, 0, 0.7410178780555725, 1.7380421161651611, 0, 0, 1.166077733039856, 6.101984977722168, 2.8639979362487793, 1.8554078340530396, 0.36941230297088623, 2.0671703815460205, 1.023340106010437, 0, 0, 2.242739200592041, 0.3063218593597412, 0, 1.294034481048584, 1.4341181516647339, 0.3312445282936096, 2.3509678840637207, 0.8047237992286682, 0.9713127613067627, 0.7362948060035706, 0.6256998777389526, 0.04578239098191261, 0, 0, 1.6565338373184204, 0, 0, 0.22979791462421417, 1.3667532205581665, 1.7365461587905884, 0.6236475706100464, 0, 0, 1.8012263774871826, 0.09735623747110367, 0.5019854307174683, 0.12693996727466583, 0.9550727009773254, 0, 2.4637787342071533, 3.0689120292663574, 0, 0.24664422869682312, 2.178596258163452, 0.43870288133621216, 0.06805898249149323, 1.0194391012191772, 0.47675764560699463, 0, 0, 1.2934319972991943, 0.5404912829399109, 0.508644163608551, 0.7082542181015015, 0, 0.8010700941085815, 0.0794057548046112, 1.0003868341445923, 0.5903266072273254, 0.7388204336166382, 0.044487953186035156, 2.4497909545898438, 0.7681124806404114, 0, 2.1967499256134033, 0, 0, 3.177820920944214, 0.747450590133667, 0, 0.20880211889743805, 0.6149495840072632, 2.9520671367645264, 0, 1.8365918397903442, 1.9629789590835571, 5.197769641876221, 0, 2.1988167762756348, 1.717389464378357, 0, 0, 0.20525048673152924, 0.4088456630706787, 0, 1.1230123043060303, 1.334733247756958, 0.5902552604675293, 0.9978445768356323, 1.0115102529525757, 0.30106255412101746, 0, 3.8921971321105957, 1.2162582874298096, 0.4866885840892792, 0, 0.11481259763240814, 0.6237710118293762, 2.0085694789886475, 1.0409375429153442, 0, 0, 1.6619586944580078, 0.452698290348053, 1.2644290924072266, 0.18437275290489197, 0, 0.788516104221344, 0.9589513540267944, 0, 0, 0, 2.6121115684509277, 0.7761307954788208, 0, 0.7318874001502991, 2.613253593444824, 0, 0.6404003500938416, 0, 0.42403945326805115, 0.3177974820137024, 0, 1.426650047302246, 0, 1.84067702293396, 1.0378892421722412, 1.2755922079086304, 0.2543671429157257, 0.41888946294784546, 0, 1.791394829750061, 0, 2.6534035205841064, 0.30660495162010193, 0.5311121940612793, 1.3223739862442017, 4.2006425857543945, 2.7700467109680176, 0.28796645998954773, 0, 1.531412124633789, 0, 0.7409151792526245, 1.0394245386123657, 1.0424116849899292, 0.283271849155426, 4.293272018432617, 0.9362173080444336, 1.1631102561950684, 0.27086111903190613, 0.07728541642427444, 1.295143723487854, 0.07567492872476578, 1.149466872215271, 0, 1.073127031326294, 0, 0, 0, 0.1836576908826828, 0, 0.7364349365234375, 2.454150915145874, 0.3763998746871948, 1.1102004051208496, 0, 1.4324181079864502, 0.89518141746521, 0.5394076108932495, 1.8788796663284302, 0, 1.3166755437850952, 0.7151849865913391, 0, 1.9080047607421875, 0.41110333800315857, 1.5927679538726807, 0.112676240503788, 0.2788894474506378, 1.29507577419281, 4.19066047668457, 0.060499612241983414, 0.42921361327171326, 0.5524209141731262, 0, 0.6389075517654419, 0, 1.5127111673355103, 0, 0, 0.28802838921546936, 3.1860439777374268, 0],
            "k": 2
        }
    }
}

json_info = es.search(index = "snl-ghostrunner-*", body = script_query, size = 20)


print(json_info)
